from BytesUnit import BytesUnit
import os

class SingleByteFreq(BytesUnit):
    def __init__(self):
        BytesUnit.__init__(self, self.__class__.__name__)

        self.fileName = None
        self.result = None

    def _cvtNgram(self, byteSeq, N=1):
        gramDict = dict()

        for idx in range(len(byteSeq)):
            gram = ''.join(byteSeq[idx:idx+N])

            if gram in gramDict:
                gramDict[gram] += 1
            else:
                gramDict[gram] = 1

        return gramDict

    def _extractByteSeq(self, inputPath):
        fd = open(inputPath)

        byteSequence = list()

        for line in fd:
            line = line.strip()
            byteSequence += line.split()[1:]

        fd.close()

        return byteSequence

    def saveResult(self):
        BytesUnit.saveResult(self) #if result is None, throw Exception
        resultPath = os.path.join(self.resDir,self.fileName)

        fd = open(resultPath+'.'+self.symbol, 'w')
        resultGram = [self.fileName]
        for key in self.result.keys():
            resultGram.append('%s:%d'%(key, self.result[key]))

        fd.write(' '.join(resultGram))
        fd.close()

    def fit_transform(self, inputPath):
        self.fileName = os.path.basename(inputPath).split('.')[0]

        byteSequence = self._extractByteSeq(inputPath)
        gramDict = self._cvtNgram(byteSequence)

        self.result = gramDict

        return self.result
