from preprocessing.apics.APIcsUnit import APIcsUnit
import os
import re


class ApiRushabh(APIcsUnit):
    def __init__(self):
        APIcsUnit.__init__(self, self.__class__.__name__)

        self.fileName = None
        self.result = None

        self.mapper = dict()
        self._init_mapper()

    def _init_mapper(self):
        resource_path = './api_from_rushabh.csv'
        fd = open(resource_path)

        for line in fd:
            line = line.strip()

            if len(line) < 1:
                continue

            data = line.split(',')

            api_name = data[0].lower()

            self.mapper[api_name] = 0
        fd.close()


    def _extract_API(self, inputPath):
        common_APIs = self.mapper.keys()

        fd = open(inputPath)
        API_freq_dict = dict()

        for line in fd:
            line = line.strip()
            result = re.findall(r'\w*\.\w*\.\w*\.\w*', line)

            for api_name in result:
                parts = api_name.split('.')

                dll_name = parts[-2]
                try:
                    api_name = parts[-1].split('_')[1].lower()
                except:
                    pass

                if api_name.lower() not in common_APIs:
                    continue

                if api_name not in API_freq_dict:
                    API_freq_dict[api_name] = 1
                else:
                    API_freq_dict[api_name] += 1

        fd.close()

        return API_freq_dict

    def saveResult(self):
        APIcsUnit.saveResult(self) #if result is None, throw Exception
        resultPath = os.path.join(self.resDir, self.fileName)

        fd = open(resultPath+'.'+self.symbol, 'w')

        resultAPI = [self.fileName]

        for key in self.result.keys():
            resultAPI.append('%s:%d' % (key, self.result[key]))

        fd.write(' '.join(resultAPI))

        fd.close()

    def fit_transform(self, inputPath):
        self.fileName = os.path.basename(inputPath).split('.')[0]

        APIcs = self._extract_API(inputPath)

        self.result = APIcs

        return APIcs
