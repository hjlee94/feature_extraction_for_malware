from preprocessing.apics.APIcsUnit import APIcsUnit
import os
import re


class FrequentAPICFG(APIcsUnit):
    def __init__(self):
        APIcsUnit.__init__(self, self.__class__.__name__)

        self.fileName = None
        self.result = None

        self.mapper = dict()
        self._init_mapper()

    def _init_mapper(self):
        resource_path = './Top_API_used.csv'
        fd = open(resource_path)

        cnt = 0
        for line in fd:

            if cnt > 217:
                break

            line = line.strip()

            if len(line) < 1:
                continue

            data = line.split(',')

            self.mapper[data[0]] = cnt

            cnt += 1

        fd.close()


    def _extract_call_sequence(self, inputPath):
        api_list = self.mapper.keys()

        fd = open(inputPath)
        API_sequence_list = list()

        for line in fd:
            line = line.strip()
            result = re.findall(r'\w*\.\w*\.\w*\.\w*', line)

            for api_name in result:
                parts = api_name.split('.')

                dll_name = parts[-2]
                try:
                    api_name = parts[-1].split('_')[1].lower()
                except:
                    pass

                if api_name not in api_list:
                    continue

                API_sequence_list.append(api_name)

        fd.close()

        return API_sequence_list

    def _makeCFG(self, APIcs):
        API_CFG_freq_dict = dict()

        for idx in range(len(APIcs)-1):
            API_2gram = APIcs[idx:idx+2]
            API_2gram = '(%s)'%','.join(API_2gram)

            if API_2gram not in API_CFG_freq_dict:
                API_CFG_freq_dict[API_2gram] = 1
            else:
                API_CFG_freq_dict[API_2gram] += 1

        return API_CFG_freq_dict

    def saveResult(self):
        APIcsUnit.saveResult(self) #if result is None, throw Exception
        resultPath = os.path.join(self.resDir, self.fileName)

        fd = open(resultPath+'.'+self.symbol, 'w')

        resultAPI = [self.fileName]

        for key in self.result.keys():
            resultAPI.append('%s:%d' % (key, self.result[key]))

        fd.write(' '.join(resultAPI))

        fd.close()

    def fit_transform(self, inputPath):
        self.fileName = os.path.basename(inputPath).split('.')[0]

        APIcs = self._extract_call_sequence(inputPath)
        APICFG = self._makeCFG(APIcs)
        self.result = APICFG

        return APIcs


if __name__ == '__main__':
    APICFG()
